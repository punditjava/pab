(function(u,l){function q(){GLOBAL.comet&&(r=GLOBAL.comet.url,m=b.ticket=GLOBAL.comet.ticket,b.objects=GLOBAL.comet.objects,t=g=!0)}function n(a,b){var c="comet_";a&&(c+=a);b&&(c+=b);return c}function h(){if(!g)return!1;k||(b.objects.length&&b.ticket?(k=!0,l.ajax({type:"GET",url:r,data:l.param(b,!0),async:!0,cache:!1,dataType:"json",timeout:7E4,success:v,error:w})):setTimeout(h,5E3))}function v(a){if(0==a.timeout){var f=a.messages;if(f&&f instanceof Array)for(i in f){var c=f[i],d=n(c.object_id,c.message_type);
p.trigger(d,[c])}b.ticket=a.ticket;b.timestamp=a.timestamp}k=!1;e=0;setTimeout(h,1E3+Math.floor(100*Math.random()))}function w(a,d,c){"Unknown ticket"==a.responseText&&null!=m&&(b.ticket=m,b.rn=0);a=1E4;0<e&&1==GLOBAL.comet.reduce||(0==e&&(a=GLOBAL.comet.timeouts.try2),1==e&&(a=GLOBAL.comet.timeouts.try3),2==e&&(a=GLOBAL.comet.timeouts.try4),2<e||(e++,k=!1,a=parseInt(a)+Math.floor(Math.random()*parseInt(a)*.1),setTimeout(h,a)))}var e=0,d={},k=!1,g=!1,t=!1,p=l("<p/>"),r=null,m=null,b={ticket:null,
objects:[],timestamp:0};q();u.Comet={listen:function(a,f,c){t||q();if(!g)return!1;d[a]||(d[a]=0,b.objects.push(a));d[a]++;p.bind(n(a,f),c)},stopListen:function(a,f,c){if(!g)return!1;if(d[a]&&(d[a]--,0===d[a])){delete d[a];var e=b.objects.indexOf(a);-1!==e&&b.objects.splice(e,1)}p.unbind(n(a,f),c)},startPolling:h,objects:d}})(window,jQuery);
