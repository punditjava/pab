var RIA_SOCK_DEFAULT_INTERVALS=[1E4,15E3,45E3,7E4,3E5],ria_sock={events:{},instance:null,connected:!1,connectionInterval:null,connectionIntervalTime:3E4,reconnectIntervals:RIA_SOCK_DEFAULT_INTERVALS.concat([]),url:GLOBAL.sock.server,on:function(a,b){this.events[a]=this.events[a]||[];this.events[a].push(b)},off:function(a,b){if(this.events[a])for(var c=0;c<this.events[a].length;c++)if(this.events[a][c]===b){this.events[a].splice(c,1);break}},emit:function(a,b){this.events[a]&&this.events[a].forEach(function(a){a(b)})},
get:function(){return this.instance},send:function(a){a.message.lang="rus";a.message.project="ria.ru";this.instance&&this.instance.send(JSON.stringify(a))},connect:function(){ria_sock.instance=new SockJS(ria_sock.url,null,{transports:["websocket"]})},reconnect:function(){ria_sock.reconnectIntervals.length&&(ria_sock.connected||setTimeout(function(){ria_sock.init()},ria_sock.reconnectIntervals.shift()))},init:function(){ria_sock.instance||ria_sock.connect();this.instance.onmessage=function(a){var b=
JSON.parse(a.data);ria_sock.emit(b.type,b);ria_sock.emit("onmessage",a)};this.instance.onopen=function(){ria_sock.connectionInterval&&clearInterval(ria_sock.connectionInterval);ria_sock.connected=!0;ria_sock.connectionInterval=setInterval(function(){ria_sock.reconnectIntervals=RIA_SOCK_DEFAULT_INTERVALS.concat([]);clearInterval(ria_sock.connectionInterval)},ria_sock.connectionIntervalTime);ria_sock.send({type:"user_join",message:{user_id:GLOBAL.user.id||null,obj_id:GLOBAL.article&&GLOBAL.article.id||
("/"===location.pathname?"main":"page")}});ria_sock.emit("onopen")};this.instance.onclose=function(a){ria_sock.connectionInterval&&clearInterval(ria_sock.connectionInterval);ria_sock.connected=!1;ria_sock.instance=null;ria_sock.reconnect();ria_sock.emit("onclose",a)};this.instance.onerror=function(a){console.error("Sock connection error",a);ria_sock.emit("onerror",a)}}};ria_sock.init();
