/**
 * Mail.ru VPAID adapter for RBAdman-HTML5 (supports SuperVideo)
 * Release date: 2020-10-22
 * Version: 1.0.6
 */
!function(h,c){"use strict";function t(t,e){this.slot=t,this.settings=e,this.started=!1}function e(t){this.slot=t}function i(t){this.slot=t}t.prototype.render=function(){if(this.slot)try{var t=decodeURIComponent(this.settings.source);this.el=Q("div",t),this.slot.appendChild(this.el),function(t){var o=function(t){return t.ownerDocument||c}(t),e=t.getElementsByTagName("script");if((e=Array.prototype.slice.call(e,0)).length){var i=0;(function t(){i<e.length&&function(t,e){var i=o.createElement("script");if(i.type="text/javascript",t.src)i.src=t.src,i.onload=src.onerror=e,t.parentNode.replaceChild(i,t);else{var n=t.text||t.textContent||t.innerHTML||"";try{i.appendChild(c.createTextNode(n))}catch(t){i.text=n}t.parentNode.replaceChild(i,t),e()}}(e[i++],t)})()}}(this.el),this.clickHandler=this.clickHandler.bind(this),this.el.addEventListener("click",this.clickHandler)}catch(t){}},t.prototype.start=function(){this.started||(this.started=!0,this.render())},t.prototype.clickHandler=function(t){var e=t.target?t.target.closest("a"):null;if(e&&e.href){t.stopPropagation();var i=e.href;"function"==typeof this.onClick&&this.onClick(i)}},t.prototype.dispose=function(){this.started=!1,this.onClick=null,this.el&&this.el.parentNode&&(this.el.removeEventListener("click",this.clickHandler),this.el.parentNode.removeChild(this.el))},e.prototype.render=function(){this.slot&&(this.el=Q("div"),this.el.setAttribute("style","position:absolute;left:0;bottom:0;height:7px;background:#fff;opacity:0.5;width:0"),this.slot.appendChild(this.el))},e.prototype.start=function(){this.started||(this.started=!0,this.render())},e.prototype.setValue=function(t){this.started&&(t=Math.max(Math.min(t,100),0),this.el.style.width=t+"%")},e.prototype.dispose=function(){this.started=!1,this.el&&this.el.parentNode&&(this.el.parentNode.removeChild(this.el),this.el=null)},i.prototype.render=function(){this.slot&&(this.el=Q("div"),this.el.setAttribute("style","position:absolute;right:12px;bottom:12px;height:22px;width:22px;cursor:pointer"),this.soundOnEl=Q("div"),this.soundOnEl.setAttribute("style","height:100%;width:100%;background:url(https://r.mradx.net/img/1A/BA1F74.svg) center center no-repeat;background-size:100% 100%;display:none"),this.el.appendChild(this.soundOnEl),this.soundOffEl=Q("div"),this.soundOffEl.setAttribute("style","height:100%;width:100%;background:url(https://r.mradx.net/img/1F/A52191.svg) center center no-repeat;background-size:100% 100%;display:none"),this.el.appendChild(this.soundOffEl),this.slot.appendChild(this.el),this.clickHandler=this.clickHandler.bind(this),this.el.addEventListener("click",this.clickHandler))},i.prototype.start=function(){this.started||(this.started=!0,this.render())},i.prototype.setValue=function(t){this.started&&(this.soundOffEl.style.display=t?"none":"block",this.soundOnEl.style.display=t?"block":"none")},i.prototype.clickHandler=function(t){t.stopPropagation(),"function"==typeof this.onClick&&this.onClick()},i.prototype.dispose=function(){this.started=!1,this.onClick=null,this.el&&this.el.parentNode&&(this.el.removeEventListener("click",this.clickHandler),this.el.parentNode.removeChild(this.el),this.el=null)};var s,n,o,r,f="https://ad.mail.ru/static/admanhtml/rbadman-html5.min.js",m=3e3,y="AdLoaded",g="AdStarted",v="AdImpression",A="AdStopped",b="AdSkipped",p="AdSkippableStateChange",l="AdSizeChange",u="AdDurationChange",k="AdVolumeChange",C="AdError",w="AdPaused",V="AdPlaying",T="AdVideoStart",N="AdVideoFirstQuartile",x="AdVideoMidpoint",E="AdVideoThirdQuartile",S="AdVideoComplete",_="AdClickThru",a="width",d="height",H="viewMode",z="volume",P="remained",M="duration",D="skippable",O=(s={},{subscribe:function(t,e,i){s[e]=s[e]||[],s[e].push({fn:t,context:i||null})},unsubscribe:function(t,e){var i=s[e]||[];if(i.length)for(var n=i.length;n--;)i[n].fn===t&&i.splice(n,1)},t:function(t){for(var e=s[t]||[],i=Array.prototype.slice.call(arguments,1),n=0,o=e.length;n<o;n++)e[n].fn.apply(e[n].context,i)}}),I=function(){var i,n=[],o=[A,b,C],s={remained:-2,duration:-2,skippable:!1},r={};r[z]=k,r[D]=p;var a=[{progress:0,event:T},{progress:25,event:N},{progress:50,event:x},{progress:75,event:E},{progress:100,event:S}];function d(t){if(!B(o,i)){var e=t===w&&!a.length;i===t||e||(i=t,n.push(i),B(o,i)?setTimeout(O.t,500,i):O.t(i))}}return{state:d,depState:function(t,e){B(n,e)&&d(t)},setSize:function(t,e,i){if(t!==s.width||e!==s.height){var n=void 0!==s.width&&void 0!==s.height;s.width=t,s.height=e,s.viewMode=i,n&&O.t(l)}},setTime:function(t){var e=isNaN(t.duration)||"number"!=typeof t.duration?-2:t.duration,i=isNaN(t.remained)||e<0?-2:t.remained,n=e!==s.duration;s.duration=e,s.remained=i,n&&O.t(u),0<=i&&0<e&&function(t){for(var e=0,i=a.length;e<i&&t>=a[e].progress;e++)O.t(a[e].event);a=a.slice(e)}(t.percent)},property:function(t,e){if(1===arguments.length)return s[t];s[t]!==e&&(s[t]=e,r[t]&&O.t(r[t]))}}}(),L={init:function(t){n=t},get:function(){return n},resize:function(t,e){n&&n.style&&(n.style.width=t+"px",n.style.height=e+"px")}},F={init:function(t){o=t},resize:function(t,e){o&&o.style&&(o.style.width=t+"px",o.style.height=e+"px")}};function R(t){return!!t&&"VPAID"===(t.apiFramework||t.api)}function B(t,e){return-1!==t.indexOf(e)}function j(t){return"number"==typeof t&&isFinite(t)&&!isNaN(t)}function J(){}function Q(t,e){var i=c.createElement(t||"div");return e?(i.innerHTML=e,i.children.length?i.children[0]:i):i}J.prototype.handshakeVersion=function(){return"2.0"},J.prototype.initAd=function(t,e,i,n,o,s){var r,a,d=this.slot=s.slot;try{a="string"==typeof o?JSON.parse(o):JSON.parse(o.AdParameters)}catch(t){return void O.t(C,"AdParameters JSON is not valid")}if((r=a.ads||a).settings&&r.settings.preroll&&r.settings.preroll.responseTime&&r.settings.preroll.responseValidityTime){var p=parseInt(r.settings.preroll.responseTime,10),l=parseInt(r.settings.preroll.responseValidityTime,10),u=Date.now?Date.now():(new Date).getTime();if(j(p)&&j(l)&&p+l<u)return void O.t(C,"VPAID Session time expired")}this.adComponents=a.components,this.initialMuteChecked=!1,L.init(s.videoSlot),L.resize(t,e),F.init(d),F.resize(t,e),I.setSize(t,e,i),function(t,e){var i;h.admanAsyncInit=function(){clearTimeout(i),t()},function(t,e){var i=c.createElement("script");i.type="text/javascript",i.src=t,e&&(i.onload=function(){e(null)},i.onerror=function(){e(new Error("External script load error"))});c.getElementsByTagName("head")[0].appendChild(i)}(f),i=setTimeout(function(){h.admanAsyncInit=null,e()},m)}(function(){var t=this._adman=new AdmanHTML;t.onReady(function(){I.state(y)}.bind(this)),t.onStarted(function(t,e){R(this._currentAd=e)||(I.state(v),I.state(g)),e.muted||void 0===I.property(z)||this.setAdVolume(I.property(z)),(e.muted||L.get().muted)&&(this.initialMuteChecked=!0,this.setAdVolume(0))}.bind(this)),t._onVPAIDStarted(function(){R(this._currentAd)&&(I.state(v),I.state(g))}.bind(this)),t.onPaused(function(){I.state(w)}),t.onPlayed(function(){I.depState(V,w)}),t.onTimeRemained(function(t){this.onAdTime(t),I.setTime(t)}.bind(this)),t.onDurationChanged(function(t){I.setTime(t)}.bind(this)),t.onSkipped(function(){I.state(b)}),t.onCompleted(function(){I.state(A)}),t.onError(function(){O.t(C,"RBAdman initialization error")}),t.onClicked(function(){O.t(_,"","",!1)}),t.init({json:r,wrapper:d,clickEl:d,videoEl:L.get(),videoQuality:e||360,browser:{}})}.bind(this),function(){O.t(C,"RBAdman.HTML load error")}.bind(this))},J.prototype.startAd=function(){this._adman&&this._adman.start(),this.initComponents()},J.prototype.stopAd=function(){this._adman&&this._adman.stop(),this.dispose()},J.prototype.resizeAd=function(t,e,i){var n="fullscreen",o=I.property(H);(i===n&&o!==n||i!==n&&o===n)&&this._adman&&this._adman.setFullscreen(i===n),I.setSize(t,e,i),L.resize(t,e),F.resize(t,e)},J.prototype.pauseAd=function(){this._adman&&this._adman.pause()},J.prototype.resumeAd=function(){this._adman&&this._adman.resume()},J.prototype.expandAd=function(){},J.prototype.getAdExpanded=function(){return!0},J.prototype.getAdSkippableState=function(){return I.property(D)},J.prototype.collapseAd=function(){},J.prototype.skipAd=function(){this._adman&&this.getAdSkippableState()&&this._adman.skip()},J.prototype.getAdIcons=function(){return!1},J.prototype.getAdCompanions=function(){return""},J.prototype.getAdDuration=function(){return I.property(M)},J.prototype.getAdRemainingTime=function(){return I.property(P)},J.prototype.getAdWidth=function(){return I.property(a)},J.prototype.getAdHeight=function(){return I.property(d)},J.prototype.getAdLinear=function(){return!0},J.prototype.setAdVolume=function(t){I.property(z,t),this.volume&&this.volume.setValue(this.getAdVolume()),this._adman&&this._currentAd&&L.get()&&(!L.get().muted||0!==t)&&this._adman.setVolume(t)},J.prototype.getAdVolume=function(){var t=I.property(z);return void 0!==t?t:1},J.prototype.onAdTime=function(t){var e=this._currentAd;e&&(e.allowClose&&t.currentTime>e.allowCloseDelay&&I.property(D,!0),!isNaN(t.duration)&&0<t.duration&&0<t.currentTime&&!this.initialMuteChecked&&(this.initialMuteChecked=!0,L.get().muted&&this.setAdVolume(0)),this.updateProgress(t))},J.prototype.subscribe=function(t,e,i){O.subscribe(t,e,i||this)},J.prototype.unsubscribe=function(t,e){O.unsubscribe(t,e)},J.prototype.initComponents=function(){this.adComponents&&(this.adComponents.button&&"html"===this.adComponents.button.type&&(this.button=new t(this.slot,this.adComponents.button),this.button.start(),this.button.onClick=function(t){t&&O.t(_,"","",!1)}.bind(this)),this.adComponents.progress&&(this.progress=new e(this.slot),this.progress.start()),this.adComponents.volume&&(this.volume=new i(this.slot),this.volume.start(),this.volume.setValue(this.getAdVolume()),this.volume.onClick=function(){var t=this.getAdVolume();this.setAdVolume(t?0:1)}.bind(this)))},J.prototype.updateProgress=function(t){if(this.progress){var e=t.currentTime,i=t.duration;!isNaN(i)&&!isNaN(e)&&0<i&&this.progress.setValue(e/i*100)}},J.prototype.dispose=function(){this.volume.el&&this.volume.dispose(),this.button&&this.button.dispose(),this.progress&&this.progress.dispose()},h.getVPAIDAd=function(){return r=r||new J}}(window,document);